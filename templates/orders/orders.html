{% extends "base.html" %}
{% block title %}确认订单 - PetPals{% endblock %}

{% block content %}
<section class="py-12 bg-neutral-50">
  <div class="container mx-auto px-4 sm:px-6 lg:px-8">
    <div class="max-w-6xl mx-auto">
      <!-- 面包屑导航 -->
      <div class="text-sm text-neutral-500 mb-8 fade-in">
        <a href="{% url 'index' %}" class="hover:text-primary transition-colors">首页</a>
        <span class="mx-2">/</span>
        <a href="{% url 'cart:cart' %}" class="hover:text-primary transition-colors">购物车</a>
        <span class="mx-2">/</span>
        <span class="text-neutral-900">确认订单</span>
      </div>

      <h1 class="text-2xl font-bold text-neutral-900 mb-8">
        <i class="fa fa-file-text-o text-primary mr-2"></i>确认订单信息
      </h1>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- 左侧订单详情 -->
        <div class="lg:col-span-2 space-y-6">
          <!-- 收货地址 -->
          <div class="bg-white rounded-xl shadow-sm p-6">
            <h2 class="text-lg font-bold text-neutral-900 mb-4 flex items-center">
              <i class="fa fa-map-marker text-primary mr-2"></i>收货地址
            </h2>
            
            <div id="address-cards-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- 地址选择 -->
              {% for address in user_addresses %}
              <div data-id="{{ address.id }}" class="border rounded-lg p-4 hover:border-primary transition-colors cursor-pointer relative address-card active">
                <div class="absolute top-4 right-4 text-primary">
                  {% if address.is_default %}
                  <i class="fa fa-check-circle text-primary"></i>
                  {% else %}
                  <i class="fa fa-circle-o text-neutral-400"></i>
                  {% endif %}
                </div>
                <h3 class="font-medium">{{ address.recipient_name }}</h3>
                <p class="text-neutral-600 text-sm mt-1">{{ address.phone_number}}</p>
                <p class="text-neutral-600 text-sm mt-1">{{ address.province }}{{ address.city }}{{ address.district }}{{ address.detail_address }}</p>
                <div class="mt-3 flex space-x-2">
                  {% if address.is_default %}
                  <span class="text-xs bg-primary/10 text-primary px-2 py-1 rounded">默认地址</span>
                  {% endif %}
                </div>
              </div>
              {% endfor %}
              <div class="border-2 border-dashed border-neutral-300 rounded-lg p-4 hover:border-primary transition-colors cursor-pointer flex items-center justify-center h-full">
                <div class="text-center">
                  <i class="fa fa-plus text-neutral-400 text-xl mb-2"></i>
                  <p class="text-neutral-600">添加新地址</p>
                </div>
              </div>
                
            </div>
          </div>

          <!-- 支付方式 -->
          <div class="bg-white rounded-xl shadow-sm p-6">
            <h2 class="text-lg font-bold text-neutral-900 mb-4 flex items-center">
              <i class="fa fa-credit-card text-primary mr-2"></i>支付方式
            </h2>
            
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
              <div id="payment-wechat" class="border rounded-lg p-4 hover:border-primary transition-colors cursor-pointer flex items-center payment-method active">
                <i class="fa fa-weixin text-green-500 text-2xl mr-3"></i>
                <div>
                  <h3 class="font-medium">微信支付</h3>
                  <p class="text-xs text-neutral-500">推荐使用微信扫码支付</p>
                </div>
                <i class="fa fa-check-circle text-primary ml-auto"></i>
              </div>
              
              <div id="payment-alipay" class="border rounded-lg p-4 hover:border-primary transition-colors cursor-pointer flex items-center payment-method">
                <i class="fa fa-credit-card text-blue-500 text-2xl mr-3"></i>
                <div>
                  <h3 class="font-medium">支付宝</h3>
                  <p class="text-xs text-neutral-500">使用支付宝扫码支付</p>
                </div>
              </div>
              
              <div id="payment-cod" class="border rounded-lg p-4 hover:border-primary transition-colors cursor-pointer flex items-center payment-method">
                <i class="fa fa-money text-green-600 text-2xl mr-3"></i>
                <div>
                  <h3 class="font-medium">货到付款</h3>
                  <p class="text-xs text-neutral-500">支持现金及移动支付</p>
                </div>
              </div>
            </div>
          </div>

          <!-- 订单商品 -->
          <div class="bg-white rounded-xl shadow-sm p-6">
            <h2 class="text-lg font-bold text-neutral-900 mb-4 flex items-center">
              <i class="fa fa-shopping-basket text-primary mr-2"></i>订单商品
            </h2>
            
            <div id="order-items-container" class="divide-y divide-neutral-200">
              {% for item in selected_items %}
              <a href="{% url 'pets:detail' item.pet.id %}">
              <div class="py-4 flex flex-col sm:flex-row">
                <img src="{{ item.pet.get_primary_image.url }}" alt="{{ item.pet.name }}" class="w-20 h-20 object-cover rounded-lg mr-4">
                <div class="flex-1">
                  <h3 class="font-medium hover:text-secondary transition-colors">{{ item.pet.name }}</h3>
                  <p class="text-sm text-neutral-600 mt-1">{{ item.pet.breed }}，{{ item.pet.gender }}</p>
                  <div class="flex justify-between items-center mt-2">
                    <span class="text-secondary font-medium">¥{{ item.pet.price }}</span>
                    <span class="text-neutral-600">x{{ item.quantity }}</span>
                  </div>
                </div>
              </div>
              </a>
              {% endfor %}
            </div>
          </div>

          <!-- 备注信息 -->
          <div class="bg-white rounded-xl shadow-sm p-6">
            <h2 class="text-lg font-bold text-neutral-900 mb-4 flex items-center">
              <i class="fa fa-comment-o text-primary mr-2"></i>订单备注
            </h2>
            
            <textarea 
              id="order-remarks"
              class="w-full border rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-colors resize-none"
              rows="3"
              placeholder="请输入您的特殊要求（如送货时间等）"
            ></textarea>
          </div>
        </div>

        <!-- 右侧结算信息 -->
        <div class="lg:col-span-1">
          <div class="bg-white rounded-xl shadow-sm p-6 sticky top-24">
            <h2 class="text-lg font-bold text-neutral-900 mb-4">订单摘要</h2>
            
            <div class="space-y-3 text-sm">
              <div class="flex justify-between">
                <span class="text-neutral-600">商品总价</span>
                <span>¥{{ total_price }}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral-600">运费</span>
                <span>{% if total_price < 199 %}¥15{% else %}免费{% endif %}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral-600">优惠券折扣</span>
                <span class="text-green-500">-¥{{ coupon_discount }}</span>
              </div>
              <div class="pt-3 border-t border-neutral-200 mt-3">
                <div class="flex justify-between items-center">
                  <span class="font-medium">实付款</span>
                  <span class="text-primary font-bold text-xl">{% if total_price < 199 %}¥{{ total_price|add:15 }}{% else %}{{ total_price }}{% endif %}</span>
                </div>
              </div>
            </div>
            
            <button id="submit-order" class="w-full mt-6 bg-primary hover:bg-primary/90 text-white font-medium py-3 px-6 rounded-lg transition-colors text-lg flex items-center justify-center">
              <span>提交订单</span>
              <i class="fa fa-arrow-right ml-2"></i>
            </button>
            
            <div class="mt-4 text-xs text-neutral-500 space-y-2">
              <p class="flex items-start">
                <i class="fa fa-shield text-primary mt-1 mr-2"></i>
                <span>付款安全保障，交易全程加密</span>
              </p>
              <p class="flex items-start">
                <i class="fa fa-truck text-primary mt-1 mr-2"></i>
                <span>满¥199免运费，预计1-3天送达</span>
              </p>
              <p class="flex items-start">
                <i class="fa fa-refresh text-primary mt-1 mr-2"></i>
                <span>支持7天无理由退换货</span>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
    

<script>
document.addEventListener('DOMContentLoaded', function() {
  // 地址选择功能
  const addressCards = document.querySelectorAll('.address-card');
  
  addressCards.forEach(card => {
    card.addEventListener('click', function() {
      // 移除所有地址卡片的选中状态
      addressCards.forEach(c => {
        c.classList.remove('active', 'border-primary');
        c.classList.add('border-neutral-300');
        
        // 移除其他卡片的勾选图标
        const icon = c.querySelector('.fa');
        if (icon) {
          icon.classList.remove('fa-check-circle', 'text-primary');
          icon.classList.add('fa-circle-o', 'text-neutral-400');
        }
      });
      
      // 设置当前卡片为选中状态
      this.classList.add('active', 'border-primary');
      this.classList.remove('border-neutral-300');
      
      // 添加勾选图标
      const currentIcon = this.querySelector('.fa');
      if (currentIcon) {
        currentIcon.classList.remove('fa-circle-o', 'text-neutral-400');
        currentIcon.classList.add('fa-check-circle', 'text-primary');
      }
    });
  });
  // 自动选中默认地址
  const defaultAddressCard = document.querySelector('.address-card:has(.text-primary.px-2.py-1.rounded)');
  if (defaultAddressCard) {
    // 触发点击事件以确保所有选中状态都正确设置
    defaultAddressCard.click();
  }
  
  // 支付方式选择功能
  const paymentMethods = document.querySelectorAll('.payment-method');
  
  paymentMethods.forEach(method => {
    method.addEventListener('click', function() {
      // 移除所有支付方式的选中状态
      paymentMethods.forEach(m => {
        m.classList.remove('active', 'border-primary');
        m.classList.add('border-neutral-300');
        
        // 隐藏其他支付方式的勾选图标
        const icon = m.querySelector('.fa-check-circle');
        if (icon) {
          icon.classList.add('hidden');
        }
      });
      
      // 设置当前支付方式为选中状态
      this.classList.add('active', 'border-primary');
      this.classList.remove('border-neutral-300');
      
      // 添加勾选图标
      const checkIcon = document.createElement('i');
      checkIcon.className = 'fa fa-check-circle text-primary ml-auto';
      this.appendChild(checkIcon);
      
    });
  });
  
  // 自动选中支付宝支付方式
  const alipayMethod = document.getElementById('payment-alipay');
  if (alipayMethod) {
    // 触发点击事件以选中支付宝
    alipayMethod.click();
  }
  
  // 提交订单功能
  const submitButton = document.getElementById('submit-order');
  
  submitButton.addEventListener('click', function() {
    // 获取选中的地址ID
    const selectedAddress = document.querySelector('.address-card.active');
    if (!selectedAddress) {
      alert('请选择收货地址');
      return;
    }
    const addressId = selectedAddress.getAttribute('data-id');
    
    // 获取选中的支付方式
    const selectedPayment = document.querySelector('.payment-method.active');
    if (!selectedPayment) {
      alert('请选择支付方式');
      return;
    }
    let paymentMethod = '';
    if (selectedPayment.id === 'payment-wechat') {
      paymentMethod = 'wechat';
    } else if (selectedPayment.id === 'payment-alipay') {
      paymentMethod = 'alipay';
    } else if (selectedPayment.id === 'payment-cod') {
      paymentMethod = 'cod';
    }
    
    // 获取订单备注
    const remarks = document.getElementById('order-remarks').value;
    
    // 收集商品信息
    const orderItems = [];
    document.querySelectorAll('#order-items-container > a').forEach(item => {
      const hrefParts = item.getAttribute('href').split('/').filter(part => part !== '');
      const petId = hrefParts[hrefParts.length - 1];
      const name = item.querySelector('h3').textContent;
      const price = item.querySelector('.text-secondary').textContent.replace('¥', '');
      const quantity = item.querySelector('.flex.justify-between .text-neutral-600').textContent.replace('x', '');
      
      orderItems.push({
        pet_id: petId,
        name: name,
        price: price,
        quantity: quantity
      });
    });
    
    // 构建订单数据
    const orderData = {
      address_id: addressId,
      payment_method: paymentMethod,
      remarks: remarks,
      items: orderItems
    };
    
    // 发送POST请求到order_create视图
    fetch("{% url 'orders:order_create' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken') // 获取CSRF令牌
      },
      body: JSON.stringify(orderData),
      redirect: 'follow' // 允许跟随重定向
    })
    .then(response => {
      // 如果是重定向响应，直接跳转
      if (response.redirected) {
        window.location.href = response.url;
        return;
      }
      
      if (response.ok) {
        return response.json();
      }
      throw new Error('订单提交失败');
    })
      .catch(error => {
        console.error('Error:', error);
        alert('提交订单时发生错误，请稍后重试');
      });
  });
  
  // 辅助函数：获取CSRF令牌
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
});
</script>
{% endblock %}