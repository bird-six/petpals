{% extends "base.html" %}
{% block title %}我的收货地址 - PetPals{% endblock %}

{% block content %}
<section class="py-16 bg-neutral-100">
  <div class="container mx-auto px-4 sm:px-6 lg:px-8">
    <h2 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-neutral-900 mb-8 fade-in">我的收货地址</h2>
    
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
      <!-- 侧边栏（复用） -->
      <div class="lg:col-span-1 fade-in" style="transition-delay: 0.1s">
        <div class="bg-white rounded-xl overflow-hidden card-hover">
          <div class="p-6 border-b border-neutral-200">
            <div class="flex items-center space-x-4">
              <img src="https://picsum.photos/id/1005/100/100" alt="用户头像" class="w-16 h-16 rounded-full object-cover border-2 border-primary">
              <div>
                <h3 class="font-bold text-lg">{{ request.user.username }}</h3>
                <p class="text-sm text-neutral-600">普通会员</p>
              </div>
            </div>
          </div>
          
          <div class="p-4">
            <ul class="space-y-1">
              <li>
                <a href="{% url 'users:user_profile' %}" data-url='{% url 'users:user_profile' %}' class="nav-link flex items-center px-4 py-3 text-neutral-700 hover:bg-neutral-100 rounded-lg transition-colors">
                  <i class="fa fa-user-o w-5 text-center mr-3"></i>
                  <span>个人信息</span>
                </a>
              </li>
              <li>
                <a href="{% url 'users:my_orders' %}" data-url='{% url 'users:my_orders' %}' class="nav-link flex items-center px-4 py-3 text-neutral-700 hover:bg-neutral-100 rounded-lg transition-colors">
                  <i class="fa fa-list-alt w-5 text-center mr-3"></i>
                  <span>我的订单</span>
                </a>
              </li>
              <li>
                <a href="{% url 'users:shopping_cart' %}" data-url='{% url 'users:shopping_cart' %}' class="nav-link flex items-center px-4 py-3 text-primary bg-primary/10 rounded-lg">
                  <i class="fa fa-shopping-cart w-5 text-center mr-3"></i>
                  <span>购物车</span>
                </a>
              </li>
              <li>
                <a href="{% url 'users:addresses' %}" data-url='{% url 'users:addresses' %}' class="nav-link flex items-center px-4 py-3 text-neutral-700 hover:bg-neutral-100 rounded-lg transition-colors">
                  <i class="fa fa-map-marker w-5 text-center mr-3"></i>
                  <span>收货地址</span>
                </a>
              </li>
              <li>
                <a href="{% url 'users:browsing_history' %}" data-url='{% url 'users:browsing_history' %}' class="nav-link flex items-center px-4 py-3 text-neutral-700 hover:bg-neutral-100 rounded-lg transition-colors">
                  <i class="fa fa-history w-5 text-center mr-3"></i>
                  <span>浏览记录</span>
                </a>
              </li>
              <li>
                <a href="{% url 'users:my_posts' %}" data-url='{% url 'users:my_posts' %}' class="nav-link flex items-center px-4 py-3 text-neutral-700 hover:bg-neutral-100 rounded-lg transition-colors">
                  <i class="fa fa-comment-o w-5 text-center mr-3"></i>
                  <span>我的发帖</span>
                </a>
              </li>
              <li>
                <a href="{% url 'users:my_favorites' %}" data-url='{% url 'users:my_favorites' %}' class="nav-link flex items-center px-4 py-3 text-neutral-700 hover:bg-neutral-100 rounded-lg transition-colors">
                  <i class="fa fa-heart-o w-5 text-center mr-3"></i>
                  <span>我的收藏</span>
                </a>
              </li>
              <li>
                <a href="{% url 'users:account_settings' %}" data-url='{% url 'users:account_settings' %}' class="nav-link flex items-center px-4 py-3 text-neutral-700 hover:bg-neutral-100 rounded-lg transition-colors">
                  <i class="fa fa-cog w-5 text-center mr-3"></i>
                  <span>账户设置</span>
                </a>
              </li>
            </ul>
          </div>
        </div>
      </div>
      
      <!-- 主内容区 -->
      <div class="lg:col-span-3 space-y-8" id="main-content">
        <div class="bg-white rounded-xl overflow-hidden card-hover fade-in" style="transition-delay: 0.2s">
          <div class="p-6 border-b border-neutral-200">
            <div class="flex justify-between items-center">
              <h3 class="text-xl font-bold flex items-center">
                <i class="fa fa-map-marker text-primary mr-2"></i>
                收货地址管理
              </h3>
              <button id="add-address-button" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition-colors">
                <i class="fa fa-plus mr-1"></i> 添加新地址
              </button>
            </div>
          </div>
          
          <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- 地址1（默认） -->
            <div class="border-2 border-primary rounded-lg p-4 relative group">
              <div class="absolute -top-3 left-4 bg-primary text-white text-xs px-2 py-0.5 rounded">
                默认地址
              </div>
              <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity flex space-x-2">
                <button class="text-neutral-500 hover:text-primary transition-colors p-1">
                  <i class="fa fa-pencil"></i> 编辑
                </button>
                <button class="text-neutral-500 hover:text-red-500 transition-colors p-1">
                  <i class="fa fa-trash-o"></i> 删除
                </button>
              </div>
              <div class="flex items-center mb-2 pt-2">
                <h4 class="font-medium mr-3">张小明</h4>
                <span class="text-neutral-600">138****6789</span>
              </div>
              <p class="text-neutral-700">北京市朝阳区建国路88号 现代城5号楼2307室</p>
              <div class="mt-3 flex items-center text-sm text-neutral-500">
                <span class="mr-3"><i class="fa fa-home mr-1"></i> 住宅</span>
                <button class="text-primary hover:underline">设为默认</button>
              </div>
            </div>
            
            <!-- 地址2 -->
            <div class="border border-neutral-200 rounded-lg p-4 relative group hover:border-primary/50 transition-colors">
              <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity flex space-x-2">
                <button class="text-neutral-500 hover:text-primary transition-colors p-1">
                  <i class="fa fa-pencil"></i> 编辑
                </button>
                <button class="text-neutral-500 hover:text-red-500 transition-colors p-1">
                  <i class="fa fa-trash-o"></i> 删除
                </button>
              </div>
              <div class="flex items-center mb-2">
                <h4 class="font-medium mr-3">张小明</h4>
                <span class="text-neutral-600">138****6789</span>
              </div>
              <p class="text-neutral-700">上海市浦东新区张江高科技园区博云路2号 浦软大厦11层</p>
              <div class="mt-3 flex items-center text-sm text-neutral-500">
                <span class="mr-3"><i class="fa fa-briefcase mr-1"></i> 公司</span>
                <button class="text-primary hover:underline">设为默认</button>
              </div>
            </div>
          </div>
          
          <!-- 新增地址表单（默认隐藏，点击添加按钮显示） -->
          <div class="p-6 border-t border-neutral-200 hidden" id="new-address-form">
            <h4 class="text-lg font-bold mb-4">添加新地址</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-neutral-700 mb-1">收件人</label>
                <input type="text" class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors" placeholder="请输入收件人姓名">
              </div>
              <div>
                <label class="block text-sm font-medium text-neutral-700 mb-1">手机号码</label>
                <input type="tel" class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors" placeholder="请输入手机号码">
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-neutral-700 mb-1">所在地区</label>
                <div class="grid grid-cols-3 gap-2">
                  <select class="px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors">
                    <option value="">省份</option>
                  </select>
                  <select class="px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors">
                    <option value="">城市</option>
                  </select>
                  <select class="px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors">
                    <option value="">区县</option>
                  </select>
                </div>
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-neutral-700 mb-1">详细地址</label>
                <textarea class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors" rows="3" placeholder="请输入详细地址"></textarea>
              </div>
              <div>
                <label class="block text-sm font-medium text-neutral-700 mb-1">地址类型</label>
                <select class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors">
                  <option value="home">住宅</option>
                  <option value="company">公司</option>
                  <option value="other">其他</option>
                </select>
              </div>
              <div class="flex items-end">
                <label class="flex items-center">
                  <input type="checkbox" class="w-5 h-5 text-primary rounded mr-2">
                  <span class="text-sm">设为默认地址</span>
                </label>
              </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
              <button class="px-4 py-2 border border-neutral-300 rounded-lg hover:bg-neutral-50 transition-colors">
                取消
              </button>
              <button class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition-colors">
                保存地址
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<div id="address-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
  <!-- 模态框背景蒙层 -->
  <div id="modal-backdrop" class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
  
  <!-- 模态框内容 -->
  <div class="relative bg-white rounded-xl shadow-2xl w-full max-w-xl mx-4 transform transition-all duration-300 scale-95 opacity-0" id="modal-content">
    <!-- 模态框头部 -->
    <div class="flex justify-between items-center p-6 border-b border-neutral-200">
      <h4 class="text-lg font-bold">添加新地址</h4>
      <button id="close-modal-button" class="text-neutral-500 hover:text-neutral-700 transition-colors">
        <i class="fa fa-times text-xl"></i>
      </button>
    </div>
    
    <!-- 模态框表单 -->
    <form id="address-form" class="p-6 space-y-4">
      <div class="space-y-2">
        <label for="recipient-name" class="block text-sm font-medium text-neutral-700">收件人</label>
        <input type="text" id="recipient-name" name="recipient_name" class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors" placeholder="请输入收货人姓名">
      </div>
      
      <div class="space-y-2">
        <label for="phone-number" class="block text-sm font-medium text-neutral-700">手机号码</label>
        <input type="tel" id="phone-number" name="phone_number" class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors" placeholder="请输入手机号码">
      </div>
      
      <div class="space-y-2">
        <label class="block text-sm font-medium text-neutral-700">所在地区</label>
        <div class="flex space-x-2">
          <select id="province" name="province" class="flex-1 px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors">
            <option value="">请选择省份</option>
            <option value="北京市">北京市</option>
            <option value="上海市">上海市</option>
            <option value="广东省">广东省</option>
            <!-- 其他省份选项 -->
          </select>
          <select id="city" name="city" class="flex-1 px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors">
            <option value="">请选择城市</option>
          </select>
          <select id="district" name="district" class="flex-1 px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors">
            <option value="">请选择区县</option>
          </select>
        </div>
      </div>
      
      <div class="space-y-2">
        <label for="address-detail" class="block text-sm font-medium text-neutral-700">详细地址</label>
        <textarea id="address-detail" name="address_detail" rows="3" class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors" placeholder="请输入详细地址信息，如街道、门牌号等"></textarea>
      </div>
      
      <div class="flex items-center">
        <input type="checkbox" id="set-default" name="set_default" class="h-4 w-4 text-primary focus:ring-primary border-neutral-300 rounded">
        <label for="set-default" class="ml-2 block text-sm text-neutral-700">设为默认收货地址</label>
      </div>
      
      <!-- 模态框底部按钮 -->
      <div class="flex space-x-3 pt-4">
        <button type="button" id="cancel-button" class="flex-1 px-6 py-2.5 bg-white border border-neutral-300 rounded-lg text-neutral-700 font-medium hover:bg-neutral-50 transition-colors">
          取消
        </button>
        <button type="submit" class="flex-1 px-6 py-2.5 bg-primary text-white rounded-lg font-medium hover:bg-primary/90 transition-colors">
          保存地址
        </button>
      </div>
    </form>
  </div>
</div>
    
<!-- 替换现有的JavaScript代码 -->
<script>
  // 模态框相关元素
  const addAddressButton = document.getElementById('add-address-button');
  const addressModal = document.getElementById('address-modal');
  const modalContent = document.getElementById('modal-content');
  const modalBackdrop = document.getElementById('modal-backdrop');
  const closeModalButton = document.getElementById('close-modal-button');
  const cancelButton = document.getElementById('cancel-button');
  const addressForm = document.getElementById('address-form');
  
  // 地址选择相关元素
  const provinceSelect = document.getElementById('province');
  const citySelect = document.getElementById('city');
  const districtSelect = document.getElementById('district');
  
  // 当前编辑的地址ID，用于区分添加和编辑操作
  let currentAddressId = null;
  
  // 显示模态框
  function showModal() {
    addressModal.classList.remove('hidden');
    // 触发重排，然后添加动画效果
    setTimeout(() => {
      modalContent.classList.remove('scale-95', 'opacity-0');
      modalContent.classList.add('scale-100', 'opacity-100');
    }, 10);
    
    // 加载省份数据
    loadProvinces();
  }
  
  // 隐藏模态框
  function hideModal() {
    modalContent.classList.remove('scale-100', 'opacity-100');
    modalContent.classList.add('scale-95', 'opacity-0');
    // 等待动画完成后隐藏整个模态框
    setTimeout(() => {
      addressModal.classList.add('hidden');
      // 重置表单和当前编辑的地址ID
      addressForm.reset();
      currentAddressId = null;
      document.querySelector('#address-modal h4').textContent = '添加新地址';
    }, 300);
  }
  
  // 从API加载省份数据
  function loadProvinces() {
    // 清空省份选择框
    provinceSelect.innerHTML = '<option value="">请选择省份</option>';
    citySelect.innerHTML = '<option value="">请选择城市</option>';
    districtSelect.innerHTML = '<option value="">请选择区县</option>';
    
    // 发送请求获取省份数据
    fetch('/users/addresses/provinces/')
      .then(response => {
        if (!response.ok) {
          throw new Error('网络响应错误: ' + response.status);
        }
        return response.json();
      })
      .then(data => {
        console.log('获取到的省份数据:', data);
        if (data.success && data.provinces) {
          // 遍历省份数据，添加到选择框
          if (Array.isArray(data.provinces)) {
            data.provinces.forEach(province => {
              const option = document.createElement('option');
              // 确保正确获取省份名称，尝试多种可能的属性名
              const provinceName = province.name || province.provinceName || province.province || province;
              option.value = provinceName;
              option.textContent = provinceName;
              provinceSelect.appendChild(option);
            });
          } else if (data.provinces.list && Array.isArray(data.provinces.list)) {
              data.provinces.list.forEach(province => {
                const option = document.createElement('option');
                // 正确使用proName属性，添加默认值避免空值
                const provinceName = province.proName || "未知省份";
                option.value = provinceName;
                option.textContent = provinceName;
                provinceSelect.appendChild(option);
              });
            }
        } else {
          alert('获取省份数据失败：' + (data.message || '未知错误'));
        }
      })
      .catch(error => {
        console.error('获取省份数据时发生错误：', error);
        alert('获取省份数据失败，请稍后重试');
      });
  }
  
  // 绑定事件监听器
  addAddressButton.addEventListener('click', showModal);
  closeModalButton.addEventListener('click', hideModal);
  cancelButton.addEventListener('click', hideModal);
  modalBackdrop.addEventListener('click', hideModal);
  
  // 点击模态框内容区域不关闭模态框
  modalContent.addEventListener('click', (e) => {
    e.stopPropagation();
  });
  
// 定义直辖市列表
const municipalities = ["北京市", "上海市", "天津市", "重庆市"];
const municipalityMap = {
  "北京市": { pname: "北京", cname: "北京市" },
  "天津市": { pname: "天津", cname: "天津市" },
  "上海市": { pname: "上海", cname: "上海市" },
  "重庆市": { pname: "重庆", cname: "重庆市" }
};
// 省份变化时的处理逻辑
provinceSelect.addEventListener('change', () => {
  const selectedProvince = provinceSelect.value;
  citySelect.innerHTML = '<option value="">请选择城市</option>';
  districtSelect.innerHTML = '<option value="">请选择区县</option>';
  
  if (selectedProvince) {
    // 判断是否为直辖市
    if (municipalities.includes(selectedProvince)) {
      // 直辖市：城市默认为自身，直接设置城市选择框并触发区县加载
      const option = document.createElement('option');
      option.value = selectedProvince; // 城市值设为直辖市名称
      option.textContent = selectedProvince;
      option.selected = true; // 自动选中
      citySelect.appendChild(option);
      
      // 手动触发城市变化事件，加载区县
      const event = new Event('change');
      citySelect.dispatchEvent(event);
    } else {
      // 普通省份：正常请求城市数据
      fetch(`/users/addresses/cities/?pname=${encodeURIComponent(selectedProvince)}`)
        .then(response => {
          if (!response.ok) throw new Error('网络响应错误: ' + response.status);
          return response.json();
        })
        .then(data => {
          console.log('获取到的城市数据:', data);
          
          if (data.success) {
            let cities = [];
            if (data.cities && data.cities.list && Array.isArray(data.cities.list)) {
              cities = data.cities.list;
            } else if (Array.isArray(data.cities)) {
              cities = data.cities;
            }
            
            if (cities.length > 0) {
              cities.forEach(city => {
                const option = document.createElement('option');
                // 城市是字符串数组，直接使用city作为名称（修正原对象属性访问错误）
                const cityName = city || "未知城市";
                option.value = cityName;
                option.textContent = cityName;
                citySelect.appendChild(option);
              });
            } else {
              citySelect.innerHTML += '<option value="">未找到城市数据</option>';
            }
          } else {
            citySelect.innerHTML += `<option value="">${data.message || '获取城市数据失败'}</option>`;
          }
        })
        .catch(error => {
          console.error('获取城市数据错误：', error);
          citySelect.innerHTML += '<option value="">获取失败，请重试</option>';
        });
    }
  }
});
  
// 城市变化时更新区县选项
citySelect.addEventListener('change', () => {
  const selectedProvince = provinceSelect.value;
  const selectedCity = citySelect.value;
  districtSelect.innerHTML = '<option value="">请选择区县</option>';
  
  if (selectedProvince && selectedCity) {
    // 处理直辖市参数：pname用简称，cname用全称
    let pname = selectedProvince;
    let cname = selectedCity;
    
    // 若为直辖市，从映射表中获取正确的pname（简称）
    if (municipalityMap.hasOwnProperty(selectedProvince)) {
      pname = municipalityMap[selectedProvince].pname;
      cname = municipalityMap[selectedProvince].cname; // 确保cname是全称
    }
    
    // 用处理后的pname和cname请求区县数据
    fetch(`/users/addresses/districts/?pname=${encodeURIComponent(pname)}&cname=${encodeURIComponent(cname)}`)
      .then(response => {
        if (!response.ok) throw new Error('网络响应错误: ' + response.status);
        return response.json();
      })
      .then(data => {
        console.log('获取到的区县数据:', data);
        
        // 解析区县数据（原有逻辑不变，适配API返回格式）
        if (data.success) {
          let districts = [];
          // 兼容第三方API的list结构（如{"message":"获取地区县成功","list":["中山区"...]}）
          if (data.districts && data.districts.list && Array.isArray(data.districts.list)) {
            districts = data.districts.list;
          } else if (data.list && Array.isArray(data.list)) { // 直接读取list字段（第三方API可能返回此结构）
            districts = data.list;
          } else if (Array.isArray(data.districts)) {
            districts = data.districts;
          }
          
          if (districts.length > 0) {
            districts.forEach(district => {
              const option = document.createElement('option');
              const districtName = district || "未知区县";
              option.value = districtName;
              option.textContent = districtName;
              districtSelect.appendChild(option);
            });
          } else {
            districtSelect.innerHTML += '<option value="">未找到区县数据</option>';
          }
        } else {
          districtSelect.innerHTML += `<option value="">${data.message || '获取区县数据失败'}</option>`;
        }
      })
      .catch(error => {
        console.error('获取区县数据错误：', error);
        districtSelect.innerHTML += '<option value="">获取失败，请重试</option>';
      });
  }
});
  
  
  // 表单提交处理
  addressForm.addEventListener('submit', (e) => {
    e.preventDefault();
    
    // 获取表单数据
    const formData = new FormData(addressForm);
    const addressData = {
      recipient_name: formData.get('recipient_name'),
      phone_number: formData.get('phone_number'),
      province: formData.get('province'),
      city: formData.get('city'),
      district: formData.get('district'),
      address_detail: formData.get('address_detail'),
      set_default: formData.get('set_default') !== null
    };
    
    // 表单验证
    if (!addressData.recipient_name) {
      alert('请输入收件人姓名');
      return;
    }
    if (!addressData.phone_number) {
      alert('请输入手机号码');
      return;
    }
    if (!addressData.province || !addressData.city || !addressData.district) {
      alert('请选择完整的地区信息');
      return;
    }
    if (!addressData.address_detail) {
      alert('请输入详细地址');
      return;
    }
    
    // 发送请求保存地址
    let url = '/users/addresses/add/';
    if (currentAddressId) {
      url = `/users/addresses/update/${currentAddressId}/`;
    }
    
    fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify(addressData)
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(data.message);
          hideModal();
          // 刷新页面以显示最新的地址列表
          location.reload();
        } else {
          alert(data.message || '保存失败，请稍后重试');
        }
      })
      .catch(error => {
        console.error('保存地址时发生错误：', error);
        alert('保存失败，请稍后重试');
      });
  });
  
  // 编辑地址功能
  document.querySelectorAll('.address-card button').forEach(button => {
    if (button.innerHTML.includes('编辑')) {
      button.addEventListener('click', function() {
        const addressCard = this.closest('.address-card');
        const addressId = addressCard.dataset.id;
        
        // 这里应该从服务器获取地址详情，然后填充表单
        // 为简化示例，这里假设我们直接从DOM中提取数据
        const recipientName = addressCard.querySelector('h4').textContent;
        const phoneNumber = addressCard.querySelector('span').textContent;
        const fullAddress = addressCard.querySelector('p').textContent;
        
        // 解析地址信息（实际应用中可能需要更复杂的解析逻辑）
        // 这里只是示例，实际应用中应该从服务器获取完整的地址数据
        document.querySelector('#address-modal h4').textContent = '编辑地址';
        document.getElementById('recipient-name').value = recipientName;
        document.getElementById('phone-number').value = phoneNumber.replace(/\*/g, ''); // 假设电话号码格式为138****6789
        
        // 显示模态框
        showModal();
        currentAddressId = addressId;
      });
    } else if (button.innerHTML.includes('删除')) {
      button.addEventListener('click', function() {
        const addressCard = this.closest('.address-card');
        const addressId = addressCard.dataset.id;
        
        if (confirm('确定要删除这个地址吗？')) {
          // 发送请求删除地址
          fetch(`/users/addresses/delete/${addressId}/`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': '{{ csrf_token }}'
            }
          })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                alert(data.message);
                // 刷新页面以显示最新的地址列表
                location.reload();
              } else {
                alert(data.message || '删除失败，请稍后重试');
              }
            })
            .catch(error => {
              console.error('删除地址时发生错误：', error);
              alert('删除失败，请稍后重试');
            });
        }
      });
    }
  });
</script>
{% endblock %}