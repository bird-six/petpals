{% extends "base.html" %}
{% block title %}我的收货地址 - PetPals{% endblock %}

{% block content %}
<section class="py-16 bg-neutral-100">
  <div class="container mx-auto px-4 sm:px-6 lg:px-8">
    <h2 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-neutral-900 mb-8 fade-in">我的收货地址</h2>
    
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
      <!-- 侧边栏（复用） -->
      <div class="lg:col-span-1 fade-in" style="transition-delay: 0.1s">
        <div class="bg-white rounded-xl overflow-hidden card-hover">
          <div class="p-6 border-b border-neutral-200">
            <div class="flex items-center space-x-4">
              <img src="https://picsum.photos/id/1005/100/100" alt="用户头像" class="w-16 h-16 rounded-full object-cover border-2 border-primary">
              <div>
                <h3 class="font-bold text-lg">{{ request.user.username }}</h3>
                <p class="text-sm text-neutral-600">普通会员</p>
              </div>
            </div>
          </div>
          
          <div class="p-4">
            <ul class="space-y-1">
              <li>
                <a href="{% url 'users:user_profile' %}" data-url='{% url 'users:user_profile' %}' class="nav-link flex items-center px-4 py-3 text-neutral-700 hover:bg-neutral-100 rounded-lg transition-colors">
                  <i class="fa fa-user-o w-5 text-center mr-3"></i>
                  <span>个人信息</span>
                </a>
              </li>
              <li>
                <a href="{% url 'users:my_orders' %}" data-url='{% url 'users:my_orders' %}' class="nav-link flex items-center px-4 py-3 text-neutral-700 hover:bg-neutral-100 rounded-lg transition-colors">
                  <i class="fa fa-list-alt w-5 text-center mr-3"></i>
                  <span>我的订单</span>
                </a>
              </li>
              <li>
                <a href="{% url 'users:shopping_cart' %}" data-url='{% url 'users:shopping_cart' %}' class="nav-link flex items-center px-4 py-3 text-primary bg-primary/10 rounded-lg">
                  <i class="fa fa-shopping-cart w-5 text-center mr-3"></i>
                  <span>购物车</span>
                </a>
              </li>
              <li>
                <a href="{% url 'users:addresses' %}" data-url='{% url 'users:addresses' %}' class="nav-link flex items-center px-4 py-3 text-neutral-700 hover:bg-neutral-100 rounded-lg transition-colors">
                  <i class="fa fa-map-marker w-5 text-center mr-3"></i>
                  <span>收货地址</span>
                </a>
              </li>
              <li>
                <a href="{% url 'users:browsing_history' %}" data-url='{% url 'users:browsing_history' %}' class="nav-link flex items-center px-4 py-3 text-neutral-700 hover:bg-neutral-100 rounded-lg transition-colors">
                  <i class="fa fa-history w-5 text-center mr-3"></i>
                  <span>浏览记录</span>
                </a>
              </li>
              <li>
                <a href="{% url 'users:my_posts' %}" data-url='{% url 'users:my_posts' %}' class="nav-link flex items-center px-4 py-3 text-neutral-700 hover:bg-neutral-100 rounded-lg transition-colors">
                  <i class="fa fa-comment-o w-5 text-center mr-3"></i>
                  <span>我的发帖</span>
                </a>
              </li>
              <li>
                <a href="{% url 'users:my_favorites' %}" data-url='{% url 'users:my_favorites' %}' class="nav-link flex items-center px-4 py-3 text-neutral-700 hover:bg-neutral-100 rounded-lg transition-colors">
                  <i class="fa fa-heart-o w-5 text-center mr-3"></i>
                  <span>我的收藏</span>
                </a>
              </li>
              <li>
                <a href="{% url 'users:account_settings' %}" data-url='{% url 'users:account_settings' %}' class="nav-link flex items-center px-4 py-3 text-neutral-700 hover:bg-neutral-100 rounded-lg transition-colors">
                  <i class="fa fa-cog w-5 text-center mr-3"></i>
                  <span>账户设置</span>
                </a>
              </li>
            </ul>
          </div>
        </div>
      </div>
      
      <!-- 主内容区 -->
      <div class="lg:col-span-3 space-y-8" id="main-content">
        <div class="bg-white rounded-xl overflow-hidden card-hover fade-in" style="transition-delay: 0.2s">
          <div class="p-6 border-b border-neutral-200">
            <div class="flex justify-between items-center">
              <h3 class="text-xl font-bold flex items-center">
                <i class="fa fa-map-marker text-primary mr-2"></i>
                收货地址管理
              </h3>
              <button id="add-address-button" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition-colors">
                <i class="fa fa-plus mr-1"></i> 添加新地址
              </button>
            </div>
          </div>
          
          <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- 地址1（默认） -->
            {% for address in addresses %}
            {% if address.is_default %}
            <div class="border-2 border-primary rounded-lg p-4 relative group address-card" data-id="{{ address.id }}">
              <div class="absolute -top-3 left-4 bg-primary text-white text-xs px-2 py-0.5 rounded">
                默认地址
              </div>
            {% else %}
            <div class="border border-neutral-200 rounded-lg p-4 relative group hover:border-primary/50 transition-colors address-card" data-id="{{ address.id }}">
            {% endif %}
              <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity flex space-x-2">
                <button class="text-neutral-500 hover:text-primary transition-colors p-1">
                  <i class="fa fa-pencil"></i> 编辑
                </button>
                <button class="text-neutral-500 hover:text-red-500 transition-colors p-1">
                  <i class="fa fa-trash-o"></i> 删除
                </button>
              </div>
              <div class="flex items-center mb-2 pt-2">
                <h4 class="font-medium mr-3">{{ address.recipient_name }}</h4>
                <span class="text-neutral-600">{{ address.phone_number }}</span>
              </div>
              <p class="text-neutral-700">{{ address.province }} {{ address.city }} {{ address.district }}</p>
              <p class="text-neutral-700">{{ address.detail_address }}</p>
              <div class="mt-3 flex items-center text-sm text-neutral-500">
                <span class="mr-3"><i class="fa fa-home mr-1"></i> 住宅</span>
                <button class="text-primary hover:underline">设为默认</button>
              </div>
            </div>
            {% endfor %}
          </div>

        </div>
      </div>
    </div>
  </div>
</section>

<!--地址表单模态框-->
<div id="address-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
  <!-- 模态框背景蒙层 -->
  <div id="modal-backdrop" class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
  
  <!-- 模态框内容 -->
  <div class="relative bg-white rounded-xl shadow-2xl w-full max-w-xl mx-4 transform transition-all duration-300 scale-95 opacity-0" id="modal-content">
    <!-- 模态框头部 -->
    <div class="flex justify-between items-center p-6 border-b border-neutral-200">
      <h4 class="text-lg font-bold">添加新地址</h4>
      <button id="close-modal-button" class="text-neutral-500 hover:text-neutral-700 transition-colors">
        <i class="fa fa-times text-xl"></i>
      </button>
    </div>
    
    <!-- 模态框表单 -->
    <form id="address-form" class="p-6 space-y-4">
      <div class="space-y-2">
        <label for="recipient-name" class="block text-sm font-medium text-neutral-700">收件人</label>
        <input type="text" id="recipient-name" name="recipient_name" class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors" placeholder="请输入收货人姓名">
      </div>
      
      <div class="space-y-2">
        <label for="phone-number" class="block text-sm font-medium text-neutral-700">手机号码</label>
        <input type="tel" id="phone-number" name="phone_number" class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors" placeholder="请输入手机号码">
      </div>
      
      <div class="space-y-2">
        <label class="block text-sm font-medium text-neutral-700">所在地区</label>
        <div class="flex space-x-2">
          <select id="province" name="province" class="flex-1 px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors">
            <option value="">请选择省份</option>
          </select>
          <select id="city" name="city" class="flex-1 px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors">
            <option value="">请选择城市</option>
          </select>
          <select id="district" name="district" class="flex-1 px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors">
            <option value="">请选择区县</option>
          </select>
        </div>
      </div>
      
      <div class="space-y-2">
        <label for="address-detail" class="block text-sm font-medium text-neutral-700">详细地址</label>
        <textarea id="address-detail" name="address_detail" rows="3" class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors" placeholder="请输入详细地址信息，如街道、门牌号等"></textarea>
      </div>
      
      <div class="flex items-center">
        <input type="checkbox" id="set-default" name="set_default" class="h-4 w-4 text-primary focus:ring-primary border-neutral-300 rounded">
        <label for="set-default" class="ml-2 block text-sm text-neutral-700">设为默认收货地址</label>
      </div>
      
      <!-- 模态框底部按钮 -->
      <div class="flex space-x-3 pt-4">
        <button type="button" id="cancel-button" class="flex-1 px-6 py-2.5 bg-white border border-neutral-300 rounded-lg text-neutral-700 font-medium hover:bg-neutral-50 transition-colors">
          取消
        </button>
        <button type="submit" class="flex-1 px-6 py-2.5 bg-primary text-white rounded-lg font-medium hover:bg-primary/90 transition-colors">
          保存地址
        </button>
      </div>
    </form>
  </div>
</div>
    

<!--删除模态框-->
<div id="delete-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
  <!-- 模态框背景蒙层 -->
  <div id="delete-modal-backdrop" class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
  
  <!-- 模态框内容 -->
  <div class="relative bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 transform transition-all duration-300 scale-95 opacity-0" id="delete-modal-content">
    <!-- 模态框头部 -->
    <div class="flex justify-between items-center p-6 border-b border-neutral-200">
      <h4 class="text-lg font-bold">确认删除</h4>
      <button id="close-delete-modal-button" class="text-neutral-500 hover:text-neutral-700 transition-colors">
        <i class="fa fa-times text-xl"></i>
      </button>
    </div>
    
    <!-- 模态框内容 -->
    <div class="p-6">
      <div class="flex items-center mb-4">
        <i class="fa fa-exclamation-triangle text-yellow-500 text-2xl mr-3"></i>
        <p class="text-neutral-700">确定要删除这个地址吗？</p>
      </div>
      
      <!-- 模态框底部按钮 -->
      <div class="flex space-x-3 pt-4">
        <button type="button" id="cancel-delete-button" class="flex-1 px-6 py-2.5 bg-white border border-neutral-300 rounded-lg text-neutral-700 font-medium hover:bg-neutral-50 transition-colors">
          取消
        </button>
        <button type="button" id="confirm-delete-button" class="flex-1 px-6 py-2.5 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700 transition-colors">
          确认删除
        </button>
      </div>
    </div>
  </div>
</div>
    
<!--提示框-->
<div id="toast-notification" class="fixed top-8 left-1/2 transform -translate-x-1/2 bg-neutral-800 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50 flex items-center">
  <i id="toast-icon" class="fa fa-check-circle mr-2"></i>
  <span id="toast-message">操作成功</span>
</div>
    
<script>
  // 表单模态框相关元素
  const addAddressButton = document.getElementById('add-address-button');
  const addressModal = document.getElementById('address-modal');
  const modalContent = document.getElementById('modal-content');
  const modalBackdrop = document.getElementById('modal-backdrop');
  const closeModalButton = document.getElementById('close-modal-button');
  const cancelButton = document.getElementById('cancel-button');
  const addressForm = document.getElementById('address-form');
  
  // 删除确认模态框相关元素
  const deleteModal = document.getElementById('delete-modal');
  const deleteModalContent = document.getElementById('delete-modal-content');
  const deleteModalBackdrop = document.getElementById('delete-modal-backdrop');
  const closeDeleteModalButton = document.getElementById('close-delete-modal-button');
  const cancelDeleteButton = document.getElementById('cancel-delete-button');
  const confirmDeleteButton = document.getElementById('confirm-delete-button');
  let addressIdToDelete = null;
    // 显示删除确认模态框
  function showDeleteModal(addressId) {
    addressIdToDelete = addressId;
    deleteModal.classList.remove('hidden');
    // 触发重排，然后添加动画效果
    setTimeout(() => {
      deleteModalContent.classList.remove('scale-95', 'opacity-0');
      deleteModalContent.classList.add('scale-100', 'opacity-100');
    }, 10);
  }
  
  // 隐藏删除确认模态框
  function hideDeleteModal() {
    deleteModalContent.classList.remove('scale-100', 'opacity-100');
    deleteModalContent.classList.add('scale-95', 'opacity-0');
    // 等待动画完成后隐藏整个模态框
    setTimeout(() => {
      deleteModal.classList.add('hidden');
      addressIdToDelete = null;
    }, 300);
  }
  
  // 绑定删除模态框事件监听器
  closeDeleteModalButton.addEventListener('click', hideDeleteModal);
  cancelDeleteButton.addEventListener('click', hideDeleteModal);
  deleteModalBackdrop.addEventListener('click', hideDeleteModal);
  
  // 点击删除模态框内容区域不关闭模态框
  deleteModalContent.addEventListener('click', (e) => {
    e.stopPropagation();
  });
  
  // 确认删除地址
  confirmDeleteButton.addEventListener('click', function() {
    if (addressIdToDelete) {
      // 发送请求删除地址
      fetch(`/users/addresses/delete/${addressIdToDelete}/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        }
      })
        .then(response => response.json())
        .then(data => {
          hideDeleteModal();
          if (data.success) {
            showToast(data.message || '删除成功！');
            setTimeout(() => {
              location.reload();
            }, 1500);
          } else {
            showToast(data.message || '删除失败，请稍后重试', 'error');
          }
        })
        .catch(error => {
          console.error('删除地址时发生错误：', error);
          hideDeleteModal();
          showToast('删除失败，请稍后重试', 'error');
        });
    }
  });
  
  
  // 提示框相关元素
  const toastNotification = document.getElementById('toast-notification');
  const toastMessage = document.getElementById('toast-message');
  const toastIcon = document.getElementById('toast-icon');
  
  // 显示提示框函数
  function showToast(message, type = 'success') {
    toastMessage.textContent = message;
    
    // 设置图标和背景色
    if (type === 'success') {
      toastIcon.className = 'fa fa-check-circle mr-2';
      toastNotification.classList.remove('bg-red-600');
      toastNotification.classList.add('bg-neutral-800');
    } else if (type === 'error') {
      toastIcon.className = 'fa fa-exclamation-circle mr-2';
      toastNotification.classList.remove('bg-neutral-800');
      toastNotification.classList.add('bg-red-600');
    }
    
    // 显示提示框
    toastNotification.style.opacity = '1';
    
    // 3秒后自动隐藏
    setTimeout(() => {
      toastNotification.style.opacity = '0';
    }, 3000);
  }
  
  // 地址选择相关元素
  const provinceSelect = document.getElementById('province');
  const citySelect = document.getElementById('city');
  const districtSelect = document.getElementById('district');
  
  // 当前编辑的地址ID，用于区分添加和编辑操作
  let currentAddressId = null;
  
  // 显示模态框
  function showModal() {
    addressModal.classList.remove('hidden');
    // 触发重排，然后添加动画效果
    setTimeout(() => {
      modalContent.classList.remove('scale-95', 'opacity-0');
      modalContent.classList.add('scale-100', 'opacity-100');
    }, 10);
    
    // 加载省份数据
    loadProvinces();
  }
  
  // 隐藏模态框
  function hideModal() {
    modalContent.classList.remove('scale-100', 'opacity-100');
    modalContent.classList.add('scale-95', 'opacity-0');
    // 等待动画完成后隐藏整个模态框
    setTimeout(() => {
      addressModal.classList.add('hidden');
      // 重置表单和当前编辑的地址ID
      addressForm.reset();
      currentAddressId = null;
      document.querySelector('#address-modal h4').textContent = '添加新地址';
    }, 300);
  }
  
  // 从API加载省份数据
  function loadProvinces() {
    // 清空省份选择框
    provinceSelect.innerHTML = '<option value="">请选择省份</option>';
    citySelect.innerHTML = '<option value="">请选择城市</option>';
    districtSelect.innerHTML = '<option value="">请选择区县</option>';
    
    // 发送请求获取省份数据
    fetch('/users/addresses/provinces/')
      .then(response => {
        if (!response.ok) {
          throw new Error('网络响应错误: ' + response.status);
        }
        return response.json();
      })
      .then(data => {
        console.log('获取到的省份数据:', data);
        if (data.success && data.provinces) {
          // 遍历省份数据，添加到选择框
          if (Array.isArray(data.provinces)) {
            data.provinces.forEach(province => {
              const option = document.createElement('option');
              // 确保正确获取省份名称，尝试多种可能的属性名
              const provinceName = province.name || province.provinceName || province.province || province;
              option.value = provinceName;
              option.textContent = provinceName;
              provinceSelect.appendChild(option);
            });
          } else if (data.provinces.list && Array.isArray(data.provinces.list)) {
              data.provinces.list.forEach(province => {
                const option = document.createElement('option');
                // 正确使用proName属性，添加默认值避免空值
                const provinceName = province.proName || "未知省份";
                option.value = provinceName;
                option.textContent = provinceName;
                provinceSelect.appendChild(option);
              });
            }
        } else {
          alert('获取省份数据失败：' + (data.message || '未知错误'));
        }
      })
      .catch(error => {
        console.error('获取省份数据时发生错误：', error);
        alert('获取省份数据失败，请稍后重试');
      });
  }
  
  // 绑定事件监听器
  addAddressButton.addEventListener('click', showModal);
  closeModalButton.addEventListener('click', hideModal);
  cancelButton.addEventListener('click', hideModal);
  modalBackdrop.addEventListener('click', hideModal);
  
  // 点击模态框内容区域不关闭模态框
  modalContent.addEventListener('click', (e) => {
    e.stopPropagation();
  });
  
// 定义直辖市列表
const municipalities = ["北京市", "上海市", "天津市", "重庆市"];
const municipalityMap = {
  "北京市": { pname: "北京", cname: "北京市" },
  "天津市": { pname: "天津", cname: "天津市" },
  "上海市": { pname: "上海", cname: "上海市" },
  "重庆市": { pname: "重庆", cname: "重庆市" }
};
// 省份变化时的处理逻辑
provinceSelect.addEventListener('change', () => {
  const selectedProvince = provinceSelect.value;
  citySelect.innerHTML = '<option value="">请选择城市</option>';
  districtSelect.innerHTML = '<option value="">请选择区县</option>';
  
  if (selectedProvince) {
    // 判断是否为直辖市
    if (municipalities.includes(selectedProvince)) {
      // 直辖市：城市默认为自身，直接设置城市选择框并触发区县加载
      const option = document.createElement('option');
      option.value = selectedProvince; // 城市值设为直辖市名称
      option.textContent = selectedProvince;
      option.selected = true; // 自动选中
      citySelect.appendChild(option);
      
      // 手动触发城市变化事件，加载区县
      const event = new Event('change');
      citySelect.dispatchEvent(event);
    } else {
      // 普通省份：正常请求城市数据
      fetch(`/users/addresses/cities/?pname=${encodeURIComponent(selectedProvince)}`)
        .then(response => {
          if (!response.ok) throw new Error('网络响应错误: ' + response.status);
          return response.json();
        })
        .then(data => {
          console.log('获取到的城市数据:', data);
          
          if (data.success) {
            let cities = [];
            if (data.cities && data.cities.list && Array.isArray(data.cities.list)) {
              cities = data.cities.list;
            } else if (Array.isArray(data.cities)) {
              cities = data.cities;
            }
            
            if (cities.length > 0) {
              cities.forEach(city => {
                const option = document.createElement('option');
                const cityName = city || "未知城市";
                option.value = cityName;
                option.textContent = cityName;
                citySelect.appendChild(option);
              });
            } else {
              citySelect.innerHTML += '<option value="">未找到城市数据</option>';
            }
          } else {
            citySelect.innerHTML += `<option value="">${data.message || '获取城市数据失败'}</option>`;
          }
        })
        .catch(error => {
          console.error('获取城市数据错误：', error);
          citySelect.innerHTML += '<option value="">获取失败，请重试</option>';
        });
    }
  }
});
  
// 城市变化时更新区县选项
citySelect.addEventListener('change', () => {
  const selectedProvince = provinceSelect.value;
  const selectedCity = citySelect.value;
  districtSelect.innerHTML = '<option value="">请选择区县</option>';
  
  if (selectedProvince && selectedCity) {
    // 处理直辖市参数：pname用简称，cname用全称
    let pname = selectedProvince;
    let cname = selectedCity;
    
    // 若为直辖市，从映射表中获取正确的pname
    if (municipalityMap.hasOwnProperty(selectedProvince)) {
      pname = municipalityMap[selectedProvince].pname;
      cname = municipalityMap[selectedProvince].cname; 
    }
    
    // 用处理后的pname和cname请求区县数据
    fetch(`/users/addresses/districts/?pname=${encodeURIComponent(pname)}&cname=${encodeURIComponent(cname)}`)
      .then(response => {
        if (!response.ok) throw new Error('网络响应错误: ' + response.status);
        return response.json();
      })
      .then(data => {
        console.log('获取到的区县数据:', data);
        
        // 解析区县数据
        if (data.success) {
          let districts = [];
          // 兼容第三方API的list结构
          if (data.districts && data.districts.list && Array.isArray(data.districts.list)) {
            districts = data.districts.list;
          } else if (data.list && Array.isArray(data.list)) { 
            districts = data.list;
          } else if (Array.isArray(data.districts)) {
            districts = data.districts;
          }
          
          if (districts.length > 0) {
            districts.forEach(district => {
              const option = document.createElement('option');
              const districtName = district || "未知区县";
              option.value = districtName;
              option.textContent = districtName;
              districtSelect.appendChild(option);
            });
          } else {
            districtSelect.innerHTML += '<option value="">未找到区县数据</option>';
          }
        } else {
          districtSelect.innerHTML += `<option value="">${data.message || '获取区县数据失败'}</option>`;
        }
      })
      .catch(error => {
        console.error('获取区县数据错误：', error);
        districtSelect.innerHTML += '<option value="">获取失败，请重试</option>';
      });
  }
});
  
  
  // 表单提交处理
  addressForm.addEventListener('submit', (e) => {
      e.preventDefault();
      
      // 获取表单数据
      const formData = new FormData(addressForm);
      const addressData = {
        recipient_name: formData.get('recipient_name'),
        phone_number: formData.get('phone_number'),
        province: formData.get('province'),
        city: formData.get('city'),
        district: formData.get('district'),
        address_detail: formData.get('address_detail'),
        set_default: formData.get('set_default') !== null
      };
      
      // 表单验证 - 这里使用HTML提示框替代alert
      if (!addressData.recipient_name) {
        showToast('请输入收件人姓名', 'error');
        return;
      }
      if (!addressData.phone_number) {
        showToast('请输入手机号码', 'error');
        return;
      }
      if (!addressData.province || !addressData.city || !addressData.district) {
        showToast('请选择完整的地区信息', 'error');
        return;
      }
      if (!addressData.address_detail) {
        showToast('请输入详细地址', 'error');
        return;
      }
      
      // 发送请求保存地址
      let url = '/users/addresses/add/';
      if (currentAddressId) {
        url = `/users/addresses/update/${currentAddressId}/`;
      }
      
      fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(addressData)
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showToast(data.message || '保存成功！');
            hideModal();
            setTimeout(() => {
              location.reload();
            }, 1500); 
          } else {
            showToast(data.message || '保存失败，请稍后重试', 'error');
          }
        })
        .catch(error => {
          console.error('保存地址时发生错误：', error);
          showToast('保存失败，请稍后重试', 'error');
        });
    });
  
  // 编辑地址功能
    document.querySelectorAll('.address-card button').forEach(button => {
    if (button.innerHTML.includes('编辑')) {
      button.addEventListener('click', function() {
        const addressCard = this.closest('.address-card');
        const addressId = addressCard.dataset.id;
        
        // 从服务器获取地址详情
        fetch(`/users/addresses/get_address/${addressId}/`)
          .then(response => {
            if (!response.ok) {
              throw new Error('获取地址详情失败');
            }
            return response.json();
          })
          .then(data => {
            if (data.success && data.address) {
              const address = data.address;
              
              // 更新模态框标题
              document.querySelector('#address-modal h4').textContent = '编辑地址';
              
              // 填充表单数据
              document.getElementById('recipient-name').value = address.recipient_name;
              document.getElementById('phone-number').value = address.phone_number;
              document.getElementById('province').value = address.province;
              document.getElementById('city').value = address.city;
              document.getElementById('district').value = address.district;
              document.getElementById('address-detail').value = address.detail_address;
              document.getElementById('set-default').checked = address.is_default;
              
              // 显示模态框
              showModal();
              currentAddressId = addressId;
              
              // 延迟加载省份和城市数据，确保模态框已显示
              setTimeout(() => {
                // 如果省份不为空，尝试加载对应的城市和区县数据
                if (address.province) {
                  // 模拟省份选择变化事件
                  const provinceEvent = new Event('change');
                  provinceSelect.dispatchEvent(provinceEvent);
                  
                  // 延迟设置城市和区县值，确保城市数据已加载
                  setTimeout(() => {
                    if (address.city) {
                      citySelect.value = address.city;
                      const cityEvent = new Event('change');
                      citySelect.dispatchEvent(cityEvent);
                       
                      // 延迟设置区县值，确保区县数据已加载
                      setTimeout(() => {
                        if (address.district) {
                          districtSelect.value = address.district;
                        }
                      }, 300);
                    }
                  }, 300);
                }
              }, 100);
            } else {
              showToast(data.message || '获取地址详情失败', 'error');
            }
          })
          .catch(error => {
            console.error('获取地址详情时发生错误：', error);
            showToast('获取地址详情失败，请稍后重试', 'error');
          });
      });
    } else if (button.innerHTML.includes('删除')) {
      button.addEventListener('click', function() {
        const addressCard = this.closest('.address-card');
        const addressId = addressCard.dataset.id;
        // 显示自定义的删除确认模态框
        showDeleteModal(addressId);
      });
    }
  });
  
  // 设为默认地址功能
function setupDefaultAddressButtons() {
  // 为所有'设为默认'按钮添加点击事件
  document.querySelectorAll('.mt-3 button:last-child').forEach(button => {
    if (button.textContent.trim() === '设为默认') {
      // 跳过已经是默认地址的按钮
      if (button.closest('.border-2.border-primary')) {
        return;
      }
      
      button.addEventListener('click', function() {
        const addressCard = this.closest('[data-id]');
        const addressId = addressCard.dataset.id;
        
        // 发送请求设置默认地址
        fetch(`/users/addresses/set_default/${addressId}/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
          }
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // 刷新页面以显示最新的地址列表和样式
              location.reload();
            } else {
              alert(data.message || '设置默认地址失败，请稍后重试');
            }
          })
          .catch(error => {
            console.error('设置默认地址时发生错误：', error);
            alert('设置默认地址失败，请稍后重试');
          });
      });
    }
  });
}

// 在页面加载完成后执行
setupDefaultAddressButtons();
  
</script>
{% endblock %}